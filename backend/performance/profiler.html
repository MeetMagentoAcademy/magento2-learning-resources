
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Profiler Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="eav.html" />
    
    
    <link rel="prev" href="../performance.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">1. Sysops</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../../sysops/part1.html">
            
                <a href="../../sysops/part1.html">
            
                    
                    Part 1 - Virtual machine
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../../sysops/part2.html">
            
                <a href="../../sysops/part2.html">
            
                    
                    Part 2 - Configuring network for VM
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../../sysops/part3.html">
            
                <a href="../../sysops/part3.html">
            
                    
                    Part 3 - Dedicated user for Magento processes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../../sysops/part4.html">
            
                <a href="../../sysops/part4.html">
            
                    
                    Part 4 - Debian repositories
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../../sysops/part5.html">
            
                <a href="../../sysops/part5.html">
            
                    
                    Part 5 - MySQL installation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="../../sysops/part6.html">
            
                <a href="../../sysops/part6.html">
            
                    
                    Part 6 - PHP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.7" data-path="../../sysops/part7.html">
            
                <a href="../../sysops/part7.html">
            
                    
                    Part 7 - Web server
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.8" data-path="../../sysops/part8.html">
            
                <a href="../../sysops/part8.html">
            
                    
                    Part 8 - Two Redis instances
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.9" data-path="../../sysops/part9.html">
            
                <a href="../../sysops/part9.html">
            
                    
                    Part 9 - Code deployment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.10" data-path="../../sysops/part10.html">
            
                <a href="../../sysops/part10.html">
            
                    
                    Part 10 - Cron jobs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.11" data-path="../../sysops/AUTHORS.html">
            
                <a href="../../sysops/AUTHORS.html">
            
                    
                    Authors
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">2. Administration</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../../administration/part1.html">
            
                <a href="../../administration/part1.html">
            
                    
                    Part 1 - Basic store configuration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../../administration/part2.html">
            
                <a href="../../administration/part2.html">
            
                    
                    Part 2 - Creating catalog - products
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../../administration/part3.html">
            
                <a href="../../administration/part3.html">
            
                    
                    Part 3 - Creating catalog - attributes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="../../administration/part4.html">
            
                <a href="../../administration/part4.html">
            
                    
                    Part 4 - Creating catalog - categories
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="../../administration/part5.html">
            
                <a href="../../administration/part5.html">
            
                    
                    Part 5 - Marketing - Catalog price rules 
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="../../administration/part6.html">
            
                <a href="../../administration/part6.html">
            
                    
                    Part 6 - Marketing - Cart price rules 
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.7" data-path="../../administration/part7.html">
            
                <a href="../../administration/part7.html">
            
                    
                    Part 7 - Marketing - Customers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.8" data-path="../../administration/part8.html">
            
                <a href="../../administration/part8.html">
            
                    
                    Part 8 - Marketing - Email templates
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.9" data-path="../../administration/part9.html">
            
                <a href="../../administration/part9.html">
            
                    
                    Part 9 - Orders management
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.10" data-path="../../administration/part10.html">
            
                <a href="../../administration/part10.html">
            
                    
                    Part 10 - Payments Methods
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.11" data-path="../../administration/part11.html">
            
                <a href="../../administration/part11.html">
            
                    
                    Part 11 - Shipping methods
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.12" data-path="../../administration/part12.html">
            
                <a href="../../administration/part12.html">
            
                    
                    Part 12 - Store Setting Conf
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.13" data-path="../../administration/part13.html">
            
                <a href="../../administration/part13.html">
            
                    
                    Part 13 - Export/Import products
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.14" data-path="../../administration/part14.html">
            
                <a href="../../administration/part14.html">
            
                    
                    Part 14 - Reports
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.15" data-path="../../administration/part15.html">
            
                <a href="../../administration/part15.html">
            
                    
                    Contact/ Q&A
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">3. Backend</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../modules.html">
            
                <a href="../modules.html">
            
                    
                    Modules
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="../modules/create.html">
            
                <a href="../modules/create.html">
            
                    
                    Creating modules
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="../modules/controller.html">
            
                <a href="../modules/controller.html">
            
                    
                    Defining controllers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3" data-path="../modules/layout.html">
            
                <a href="../modules/layout.html">
            
                    
                    Rendering page layout
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4" data-path="../modules/translations.html">
            
                <a href="../modules/translations.html">
            
                    
                    Translations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5" data-path="../modules/store_configuration.html">
            
                <a href="../modules/store_configuration.html">
            
                    
                    Store configuration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6" data-path="../modules/flash_message.html">
            
                <a href="../modules/flash_message.html">
            
                    
                    Flash message
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.7" data-path="../modules/database.html">
            
                <a href="../modules/database.html">
            
                    
                    Acessing databade
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.8" data-path="../modules/service_contracts.html">
            
                <a href="../modules/service_contracts.html">
            
                    
                    APIs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../performance.html">
            
                <a href="../performance.html">
            
                    
                    Performance
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="4.2.1" data-path="profiler.html">
            
                <a href="profiler.html">
            
                    
                    Profiler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.2" data-path="eav.html">
            
                <a href="eav.html">
            
                    
                    EAV explained
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../di.html">
            
                <a href="../di.html">
            
                    
                    Dependency Injection
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">4. Frontend</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../../frontend/themes/overview.html">
            
                <a href="../../frontend/themes/overview.html">
            
                    
                    Themes
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.1" data-path="../../frontend/themes/structure.html">
            
                <a href="../../frontend/themes/structure.html">
            
                    
                    Structure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2" data-path="../../frontend/themes/inheritance.html">
            
                <a href="../../frontend/themes/inheritance.html">
            
                    
                    Inheritance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.3" data-path="../../frontend/themes/debug.html">
            
                <a href="../../frontend/themes/debug.html">
            
                    
                    Debuging
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="../../frontend/layout/overview.html">
            
                <a href="../../frontend/layout/overview.html">
            
                    
                    Layout
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.2.1" data-path="../../frontend/layout/types.html">
            
                <a href="../../frontend/layout/types.html">
            
                    
                    Types
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.2" data-path="../../frontend/layout/examples.html">
            
                <a href="../../frontend/layout/examples.html">
            
                    
                    Examples
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="../../frontend/templates/overview.html">
            
                <a href="../../frontend/templates/overview.html">
            
                    
                    Templates
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="../../frontend/styles/overview.html">
            
                <a href="../../frontend/styles/overview.html">
            
                    
                    Styles
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.4.1" data-path="../../frontend/styles/grunt.html">
            
                <a href="../../frontend/styles/grunt.html">
            
                    
                    Grunt
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.4.2" data-path="../../frontend/styles/sass.html">
            
                <a href="../../frontend/styles/sass.html">
            
                    
                    SASS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.4.3" data-path="../../frontend/styles/magento-ui.html">
            
                <a href="../../frontend/styles/magento-ui.html">
            
                    
                    Magento UI
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.5" data-path="../../frontend/javascript/overview.html">
            
                <a href="../../frontend/javascript/overview.html">
            
                    
                    JavaScript
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.5.1" data-path="../../frontend/javascript/requirejs.html">
            
                <a href="../../frontend/javascript/requirejs.html">
            
                    
                    Require.js
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.5.2" data-path="../../frontend/javascript/using-amd.html">
            
                <a href="../../frontend/javascript/using-amd.html">
            
                    
                    AMD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.5.3" data-path="../../frontend/javascript/custom.html">
            
                <a href="../../frontend/javascript/custom.html">
            
                    
                    Custom modules
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Profiler</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="profiler">Profiler</h1>
<p>Magento2 comes with build-in profiler that could be easily used to track performance issues.</p>
<h2 id="enabling-profiler">Enabling profiler</h2>
<p>Easiest way to enable profiler is to set enviromental variable <code>MAGE_PROFILE</code>.
In orer to achieve that edit and reload nginx configuration.
Adding <code>fastcgi_param MAGE_PROFILER 1;</code> in location matching <code>index.php</code> path.
With profiler enabled You will see large table appended to end of every page.</p>
<h2 id="bad-code-example">Bad code example</h2>
<p>Now let us add some bad code example to our system so we can see how to use profiler to pin-point possible performance problems.</p>
<p>Following product reviews example let&apos;s add to the main page block displaying five recent reviews and corresponding products.</p>
<p>Start with creating block class that will use previosly implemented service contract to fetch recent reviews and acquire products related to those reviews.</p>
<pre><code class="lang-php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title">MMAcademy</span>\<span class="hljs-title">MicroReview</span>\<span class="hljs-title">Block</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Magento</span>\<span class="hljs-title">Catalog</span>\<span class="hljs-title">Api</span>\<span class="hljs-title">Data</span>\<span class="hljs-title">ProductInterface</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Magento</span>\<span class="hljs-title">Catalog</span>\<span class="hljs-title">Api</span>\<span class="hljs-title">ProductRepositoryInterface</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Magento</span>\<span class="hljs-title">Framework</span>\<span class="hljs-title">View</span>\<span class="hljs-title">Element</span>\<span class="hljs-title">Template</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">MMAcademy</span>\<span class="hljs-title">MicroReview</span>\<span class="hljs-title">Api</span>\<span class="hljs-title">ReviewRepositoryInterface</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Recent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Template</span>
</span>{
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> ReviewRepositoryInterface
     */</span>
    <span class="hljs-keyword">private</span> $reviewRepository;
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> ProductRepositoryInterface
     */</span>
    <span class="hljs-keyword">private</span> $productRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(
        Template\Context $context,
        ReviewRepositoryInterface $reviewRepository,
        ProductRepositoryInterface $productRepository,
        array $data = []
    )</span> </span>{
        <span class="hljs-keyword">parent</span>::__construct($context, $data);
        $this-&gt;reviewRepository = $reviewRepository;
        $this-&gt;productRepository = $productRepository;
    }

    <span class="hljs-keyword">protected</span> $_template = <span class="hljs-string">&apos;MMAcademy_MicroReview::recent.phtml&apos;</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRecent</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> $this-&gt;reviewRepository-&gt;getRecent();
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@param</span> int $productId
     * <span class="hljs-doctag">@return</span> ProductInterface
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getProduct</span><span class="hljs-params">($productId)</span>
    </span>{
        <span class="hljs-keyword">return</span> $this-&gt;productRepository-&gt;getById($productId);
    }
}
</code></pre>
<p>As You can see we used constructor dependency injection to require two service contracts: review repository and product repository.
Note that we call parent constructor of class we are extending.
This comes with additional constructor parameters that have to be provided based on parent class definition.
As You may remember all prevoius cases when we did declare block class we did not had to override constructor method because all dependencies were provided.
There are a lot of dependencies provided for template block - in order to simplify extending those all dependencies are passed to parent block via context object.</p>
<blockquote>
<p>Be extra careful with Context objects as You will encounter quite a lot of them thorough the system.
Always verify if namespaces and <code>use</code> statements point to correct Context object.</p>
</blockquote>
<p>Now let&apos;s add simple template that for this block.</p>
<pre><code class="lang-html"><span class="php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> \MMAcademy\MicroReview\Block\Recent $block */</span> <span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span><span class="php"><span class="hljs-meta">&lt;?</span>= __(<span class="hljs-string">&apos;Recent reviews&apos;</span>) <span class="hljs-meta">?&gt;</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
<span class="php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">foreach</span> ($block-&gt;getRecent() <span class="hljs-keyword">as</span> $review): <span class="hljs-meta">?&gt;</span></span>
    <span class="php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> \MMAcademy\MicroReview\Model\Review $review */</span>
    $product = $block-&gt;getProduct($review-&gt;getProductId())
    <span class="hljs-meta">?&gt;</span></span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;review&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;review-product&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;&lt;?= $product-&gt;getProductUrl() ?&gt;&quot;</span>&gt;</span><span class="php"><span class="hljs-meta">&lt;?</span>= $product-&gt;getName() <span class="hljs-meta">?&gt;</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;review-message&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">blockquote</span>&gt;</span>
            <span class="php"><span class="hljs-meta">&lt;?</span>= $block-&gt;escapeHtml($review-&gt;getMessage()) <span class="hljs-meta">?&gt;</span></span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">blockquote</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;review-created_at&quot;</span>&gt;</span>
            <span class="php"><span class="hljs-meta">&lt;?</span>= $block-&gt;formatTime($review-&gt;getCreatedAt(), \IntlDateFormatter::LONG, <span class="hljs-keyword">true</span>) <span class="hljs-meta">?&gt;</span></span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">endforeach</span> <span class="hljs-meta">?&gt;</span></span>
</code></pre>
<p>And don&apos;t forget about layout xml file that will enable us to show this block on main page - <code>view/frontend/layout/cms_index_index.xml</code></p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span><span class="hljs-meta">?&gt;</span></span>

<span class="hljs-tag">&lt;<span class="hljs-name">page</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="hljs-attr">layout</span>=<span class="hljs-string">&quot;3columns&quot;</span>
      <span class="hljs-attr">xsi:noNamespaceSchemaLocation</span>=<span class="hljs-string">&quot;urn:magento:framework:View/Layout/etc/page_configuration.xsd&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">referenceContainer</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;main&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">block</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;micro_review.recent&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;MMAcademy\MicroReview\Block\Recent&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">referenceContainer</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">page</span>&gt;</span>
</code></pre>
<p>After flushing all caches and ensuring our block displays properly (and displays 5 products - be sure to add some reviews to see similar results as described below) flush only <code>full_page</code> cache - this will allow us to analysis of page rendering with warm magento cache and with cold full page cache.</p>
<p>By default profiler shows automatically track all rendered templates, all observer events and some trackers added by core developers.
Let&apos;s look at two tracked entries:</p>
<ul>
<li><code>magento</code> this tracks almost full execution of magento activity and page rendering - in my case it was almost a second</li>
<li><code>TEMPLATE:/(...)/view/frontend/templates/recent.phtml</code> this tracks our template rendering - in my case it was almost half a second, so our &quot;bad code&quot; made request to main page almost twice as long!</li>
</ul>
<h2 id="using-profiler">Using profiler</h2>
<p>Profiling results are displayed as hierarhy so we can see that events or subtemplates were executed during rendering of our block.
We can see <code>EVENT:magento_catalog_api_data_productinterface_load_after</code> executed five times while rendering our block - in my case this took about a tenth of a second.
Let&apos;s add custom profiler tracker around product details loading as it may be the source of our bad performance.</p>
<p>All we have to do is to add constructor paremter with type of <code>\Magento\Framework\Profiler</code> and call on it methods <code>start($timerName)</code> and <code>stop($timerName)</code> around code we want to measure.
Here is full class code.</p>
<pre><code class="lang-php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title">MMAcademy</span>\<span class="hljs-title">MicroReview</span>\<span class="hljs-title">Block</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Magento</span>\<span class="hljs-title">Catalog</span>\<span class="hljs-title">Api</span>\<span class="hljs-title">Data</span>\<span class="hljs-title">ProductInterface</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Magento</span>\<span class="hljs-title">Catalog</span>\<span class="hljs-title">Api</span>\<span class="hljs-title">ProductRepositoryInterface</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Magento</span>\<span class="hljs-title">Framework</span>\<span class="hljs-title">Profiler</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Magento</span>\<span class="hljs-title">Framework</span>\<span class="hljs-title">View</span>\<span class="hljs-title">Element</span>\<span class="hljs-title">Template</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">MMAcademy</span>\<span class="hljs-title">MicroReview</span>\<span class="hljs-title">Api</span>\<span class="hljs-title">ReviewRepositoryInterface</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Recent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Template</span>
</span>{
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> ReviewRepositoryInterface
     */</span>
    <span class="hljs-keyword">private</span> $reviewRepository;
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> ProductRepositoryInterface
     */</span>
    <span class="hljs-keyword">private</span> $productRepository;
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> Profiler
     */</span>
    <span class="hljs-keyword">private</span> $profiler;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(
        Template\Context $context,
        ReviewRepositoryInterface $reviewRepository,
        ProductRepositoryInterface $productRepository,
        Profiler $profiler,
        array $data = []
    )</span> </span>{
        <span class="hljs-keyword">parent</span>::__construct($context, $data);
        $this-&gt;reviewRepository = $reviewRepository;
        $this-&gt;productRepository = $productRepository;
        $this-&gt;profiler = $profiler;
    }

    <span class="hljs-keyword">protected</span> $_template = <span class="hljs-string">&apos;MMAcademy_MicroReview::recent.phtml&apos;</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRecent</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> $this-&gt;reviewRepository-&gt;getRecent();
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@param</span> int $productId
     * <span class="hljs-doctag">@return</span> ProductInterface
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getProduct</span><span class="hljs-params">($productId)</span>
    </span>{
        $this-&gt;profiler-&gt;start(<span class="hljs-keyword">__METHOD__</span>);
        $product = $this-&gt;productRepository-&gt;getById($productId);
        $this-&gt;profiler-&gt;stop(<span class="hljs-keyword">__METHOD__</span>);

        <span class="hljs-keyword">return</span> $product;
    }
}
</code></pre>
<p>As we can see in the results we were right.
Calling five time method <code>getProduct($productId)</code> is responsible for 99% of block rendering time.</p>
<p>We did find most common Magento perfomance problem - loading database objects in a loop.
This sould be addressed by loading all products before we enter loop using database collection objects.</p>
<p>First let&apos;s try using different method of product repository - <code>getList</code> to fetch all required products based on their IDs.
In order to do that we need to populate search criteria object with appropriate filter.
To do so, we will iterate over loaded reviews when we load them for the first time and gather all product IDs.
Then we will have to add requirement for search criteria builder factory object (<code>\Magento\Framework\Api\SearchCriteriaBuilderFactory</code>) in our construtor - this will allow us to get unique instance of search critera builder that will create final immutable search criteria object.
Next we will call <code>getList</code> on product repository interface and store results in an associative array using product IDs as array keys.
Full example code below.</p>
<pre><code class="lang-php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title">MMAcademy</span>\<span class="hljs-title">MicroReview</span>\<span class="hljs-title">Block</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Magento</span>\<span class="hljs-title">Catalog</span>\<span class="hljs-title">Api</span>\<span class="hljs-title">Data</span>\<span class="hljs-title">ProductInterface</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Magento</span>\<span class="hljs-title">Catalog</span>\<span class="hljs-title">Api</span>\<span class="hljs-title">ProductRepositoryInterface</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Magento</span>\<span class="hljs-title">Framework</span>\<span class="hljs-title">Api</span>\<span class="hljs-title">SearchCriteriaBuilder</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Magento</span>\<span class="hljs-title">Framework</span>\<span class="hljs-title">Api</span>\<span class="hljs-title">SearchCriteriaBuilderFactory</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Magento</span>\<span class="hljs-title">Framework</span>\<span class="hljs-title">Profiler</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Magento</span>\<span class="hljs-title">Framework</span>\<span class="hljs-title">View</span>\<span class="hljs-title">Element</span>\<span class="hljs-title">Template</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">MMAcademy</span>\<span class="hljs-title">MicroReview</span>\<span class="hljs-title">Api</span>\<span class="hljs-title">Data</span>\<span class="hljs-title">ReviewInterface</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">MMAcademy</span>\<span class="hljs-title">MicroReview</span>\<span class="hljs-title">Api</span>\<span class="hljs-title">ReviewRepositoryInterface</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Recent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Template</span>
</span>{
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> ReviewRepositoryInterface
     */</span>
    <span class="hljs-keyword">private</span> $reviewRepository;
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> ProductRepositoryInterface
     */</span>
    <span class="hljs-keyword">private</span> $productRepository;
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> Profiler
     */</span>
    <span class="hljs-keyword">private</span> $profiler;
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> ProductInterface[]
     */</span>
    <span class="hljs-keyword">private</span> $products = [];
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> SearchCriteriaBuilderFactory
     */</span>
    <span class="hljs-keyword">private</span> $searchCriteriaBuilderFactory;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(
        Template\Context $context,
        ReviewRepositoryInterface $reviewRepository,
        ProductRepositoryInterface $productRepository,
        SearchCriteriaBuilderFactory $searchCriteriaBuilderFactory,
        Profiler $profiler,
        array $data = []
    )</span> </span>{
        <span class="hljs-keyword">parent</span>::__construct($context, $data);
        $this-&gt;reviewRepository = $reviewRepository;
        $this-&gt;productRepository = $productRepository;
        $this-&gt;profiler = $profiler;
        $this-&gt;searchCriteriaBuilderFactory = $searchCriteriaBuilderFactory;
    }

    <span class="hljs-keyword">protected</span> $_template = <span class="hljs-string">&apos;MMAcademy_MicroReview::recent.phtml&apos;</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRecent</span><span class="hljs-params">()</span>
    </span>{
        $recent = $this-&gt;reviewRepository-&gt;getRecent();
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($this-&gt;products)) {
            $this-&gt;preloadProducts($recent);
        }

        <span class="hljs-keyword">return</span> $recent;
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@param</span> int $productId
     * <span class="hljs-doctag">@return</span> ProductInterface
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getProduct</span><span class="hljs-params">($productId)</span>
    </span>{
        <span class="hljs-keyword">return</span> $this-&gt;products[$productId];
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@param</span> ReviewInterface[] $recent
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">preloadProducts</span><span class="hljs-params">($recent)</span>
    </span>{
        $this-&gt;profiler-&gt;start(<span class="hljs-keyword">__METHOD__</span>);
        $productIds = [];
        <span class="hljs-keyword">foreach</span> ($recent <span class="hljs-keyword">as</span> $review) {
            $productIds[] = $review-&gt;getProductId();
        }
        <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> SearchCriteriaBuilder $searchCriteriaBuilder */</span>
        $searchCriteriaBuilder = $this-&gt;searchCriteriaBuilderFactory-&gt;create();
        $searchCriteria = $searchCriteriaBuilder-&gt;addFilter(<span class="hljs-string">&apos;entity_id&apos;</span>, $productIds, <span class="hljs-string">&apos;in&apos;</span>)-&gt;create();
        $products = $this-&gt;productRepository-&gt;getList($searchCriteria)-&gt;getItems();

        <span class="hljs-keyword">foreach</span> ($products <span class="hljs-keyword">as</span> $product) {
            $this-&gt;products[$product-&gt;getId()] = $product;
        }
        $this-&gt;profiler-&gt;stop(<span class="hljs-keyword">__METHOD__</span>);
    }
}
</code></pre>
<p>This gave us nice improvement - in my case it was 30% faster.</p>
<h2 id="next-steps">Next steps</h2>
<ul>
<li><a href="eav.html">Entity Attribute Value explained</a></li>
<li><a href="https://github.com/phacility/xhprof" target="_blank">xhprof - function level profiler for PHP</a></li>
<li><a href="https://xdebug.org/" target="_blank">XDebug - debugger and profiler tool for PHP</a></li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../performance.html" class="navigation navigation-prev " aria-label="Previous page: Performance">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="eav.html" class="navigation navigation-next " aria-label="Next page: EAV explained">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Profiler","level":"4.2.1","depth":2,"next":{"title":"EAV explained","level":"4.2.2","depth":2,"path":"backend/performance/eav.md","ref":"backend/performance/eav.md","articles":[]},"previous":{"title":"Performance","level":"4.2","depth":1,"path":"backend/performance.md","ref":"backend/performance.md","articles":[{"title":"Profiler","level":"4.2.1","depth":2,"path":"backend/performance/profiler.md","ref":"backend/performance/profiler.md","articles":[]},{"title":"EAV explained","level":"4.2.2","depth":2,"path":"backend/performance/eav.md","ref":"backend/performance/eav.md","articles":[]}]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"backend/performance/profiler.md","mtime":"2018-01-15T09:27:58.963Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-01-15T09:30:14.962Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

